<html>
<title>
</title>
<body oncontextmenu="return false">
<script src="./js/phaser.min.js"></script>
<script>

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
  game.load.spritesheet('tile', 'assets/tiles.png', 10, 10, 14);
}

var width = 10;
var height = 10;
var mineCount = 10;
var mineMap;
var tileScale = 3;

function create() {
  game.stage.backgroundColor = '#e8e8e8';
  mineMap = genMineMap(width, height, mineCount);
  for (var i = 0; i < height; i++) {

    for (var j = 0; j < width; j++) {
      var onClickHandler = (function() {
        var tile = mineMap[i][j];

        return function(sprite, pointer) {
          console.log(pointer);
          frame = getFrame(tile);
          console.log(this.formerMouse);
            console.log(this.input.mouse.button);
            console.log(Phaser.Mouse.RIGHT_BUTTON);
          if (tile.mine) {
            if(this.input.mouse.button === Phaser.Mouse.RIGHT_BUTTON) {
              tile.frame = 2;
              return true;
            } else {
              revealAll();
            }
          } else {
            if (tile.neighborMineCount == 0) {
              if (!tile.known) {
                tile.sprite.frame = frame;
                expandTile(tile.x, tile.y, mineMap);
              }
            } else {
              tile.sprite.frame = frame;
            }
          }
        }
      })();

      var tileSprite = game.add.sprite(i*10*tileScale, j*10*tileScale, 'tile', 1);
      tileSprite.frame = 1;
      tileSprite.scale.setTo(tileScale, tileScale);
      tileSprite.inputEnabled = true;
      //tileSprite.events.onInputDown.add(onClickHandler, this);
      tileSprite.events.onInputDown.add(function(s,p) {
        console.log(this);
        console.log(s);
        console.log(p);
      }, this);
      mineMap[i][j].sprite = tileSprite;
    }
  }
}

function revealAll() {
  for (var i = 0; i < height; i++) {
    for (var j = 0; j < width; j++) {
      var tile = mineMap[i][j];
      if (!tile.known) {
        tile.known = true;
        tile.sprite.frame = getFrame(tile);
      }
    }
  }
}

function getFrame(tile) {
  if (tile.mine) {
    return 3;
  } else if (tile.neighborMineCount == 0) {
    return 0;
  } else {
    return tile.neighborMineCount+3;
  }
}

function update() {
}

function genMineMap(width, height, mineCount) {
  var map = [];
  for (var i = 0; i < height; i++) {
    map.push([]);
    for (var j = 0; j < width; j++) {
      map[i].push({ 
        x: j,
        y: i,
        mine: false,
        neighborMineCount: 0,
        known: false
      });
    }
  }

  for (var i = 0; i < mineCount; i++) {
    while (true) {
      x = Math.floor(Math.random()*width);
      y = Math.floor(Math.random()*height);
      if (!map[y][x].mine) {
        map[y][x].mine = true;

        for (var dx = -1; dx <= 1; dx++) {
          for (var dy = -1; dy <= 1; dy ++) {
            if (!(dx == 0 && dy == 0) && y+dy >= 0 && y+dy < height && x+dx >= 0 && x+dx < width) {
              map[y+dy][x+dx].neighborMineCount++;
            }
          }
        }

        break;
      }
    }
  }

  return map;
}

function expandTile(x, y, mineMap) {
  var tile = mineMap[y][x];
  tile.known = true;

  for (var dx = -1; dx <= 1; dx++) {
    for (var dy = -1; dy <= 1; dy++) {
      if (!(dx == 0 && dy == 0) && x+dx >= 0 && x+dx < width && y+dy >= 0 && y+dy < height) {
        var t = mineMap[y+dy][x+dx];
        if (!t.known) {
          var frame = getFrame(t);
          t.sprite.frame = frame;
          if (t.neighborMineCount == 0) {
            expandTile(x+dx, y+dy, mineMap);
          }
        }
      }
    }
  }
}
</script>
</body>
</html>
